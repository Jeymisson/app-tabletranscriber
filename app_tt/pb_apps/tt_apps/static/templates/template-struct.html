<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">


<div class="row">

  <div class="span8 offset2" style="height:50px">

   	<div id="success" class="alert alert-success" style="display:none;">
	   	<a class="close">x</a>
	    <p><span><strong>#</strong></span><span>#</span></p>
	</div>
    <div id="finish" class="alert alert-success" style="display:none;">
      <p><span><strong>#</strong></span><span>#</span></p>
      <!--
      <br/>
      <div class="alert-actions">
              <a id="back" class="btn small" href="/">#</a>
              <a id="other_apps" class="btn small" href="/app">#</a>
      </div>
      -->
    </div>
    <div id="error" class="alert alert-error" style="display:none;">
      <a class="close">x</a>
      <p><span><strong>#</strong></span><span>#</span></p>
  </div>
  <div id="workflowtask" class="alert alert-success" style="display:none; cursor:pointer;">
        <a class="close"></a>
       <p><span>#</span></p>
    </div>

  </div> <!-- End Success and Error Messages for the user -->
</div>

<div class="row skeleton">  <!-- Start Skeleton -->
	<div class="span7">
	    <h1 id="question"></h1> <!-- The question will be loaded here -->
	    <p><span>#</span><span id="task-id" class="label label-warning">#</span></p> 
	    <p><span id="progress-from">#</span><span id="done" class="label label-info" style="margin-right: 5px"></span><span id="progress-to">#</span>
	    <!-- Progress bar for the user -->
	    <span id="total" class="label label-inverse"></span></p>
	    <div class="progress progress-striped">
	     	  <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
	    </div>
	</div>
</div><!-- End of Skeleton -->

<div class="skeleton">

	<!-- <img id="loading" src="#server/images/loading.gif"/> -->
	<div id="container" style="position: relative;" data-toggle="context" data-target="#context-menu">
		<div id="context-menu" style="position: absolute;" >
		  <ul id="remover-menu" class="dropdown-menu" role="menu">
		    <li class="menu-item"><a tabindex="1" href="#">Remover linha/coluna</a></li>
		    <li class="menu-item"><a tabindex="2" href="#">Remover segmento</a></li>
		  </ul>
		</div>
	    	<div id="canvas-container" style="margin: 10px"></div>
	</div>

	<!--  Radio buttons para definir qual a ação que o usuário -->
	<div id="adicionar_linha_coluna" style="display: none; margin-bottom: 10px" >
	        <button id="button_addline" class="btn" style="float: left; margin-right: 10px" onclick="adicionarNovaLinha();">#</button>
	        <button id="button_addcolumn" class="btn" style="margin-right: 80px" onclick="adicionarNovaColuna();">#</button>
	        <button id="button_finished" class="btn btn-success" onclick="submitTask()">#</button>
	</div>
</div>

<script src="#server/js/kinetic.js"></script>
<script type="text/javascript" src="#server/js/jquery.i18n.min.js"></script>
<script type="text/javascript" src="#server/js/tt-struct-i18n.js"></script>
<script type="text/javascript" src="#server/js/throbber/throbber.js" ></script>
<script type="text/javascript" src="#server/js/bootstrap-contextmenu.js"></script>
<script type="text/javascript" charset="utf-8" src="#server/js/tt3.js"></script>

<style>

canvas {
	border: 1px solid #9C9898;
}

#loading {
	position: absolute;
	z-index: 10000;
	width: 100px;
	height: 100px;
}
</style>    
    
<script type="text/javascript" charset="utf-8">

    $(window).load(function(){
		$("#question").text($.i18n._('question'));
		$("#question span:first").text($.i18n._('task_name'));
		$("#button_finished").text($.i18n._('button_finished'));
		$("#button_addline").text($.i18n._('button_addline'));
       		$("#button_addcolumn").text($.i18n._('button_addcolumn'));
		$("#button_rmseg label").text($.i18n._('button_rmseg'));
		$("#button_rmline label").text($.i18n._('button_rmline'));
	        $("#button_mvline label").text($.i18n._('button_mvline'));
		$("#success strong").text($.i18n._('well_done'));
		$("#success span:nth-child(2)").text($.i18n._('saved'));
		$("#finish strong").text($.i18n._('congratulations'));
		$("#finish span:nth-child(2)").text($.i18n._('finished'));
		$("#error strong").text($.i18n._('error'));
		$("#error span:nth-child(2)").text($.i18n._('err_msg'));
      	        $("#workflowtask span:first").text($.i18n._('workflowtask'));
		$("#progress-from").text($.i18n._('progress-from'));
		$("#progress-to").text($.i18n._('progress-to'));
    });

    function loadUserProgress() {
	pybossa.userProgress(task_shortname).done(function(data){
		var pct = Math.round((data.done*100)/data.total);
		$("#progress").css("width", pct.toString() +"%");
		$("#progress").attr("title", pct.toString() + "% completed!");
		$("#progress").tooltip({'placement': 'left'}); 
		$("#total").text(data.total);
		$("#done").text(data.done);
	});
    }


    $(".menu-item").click(function () {
        var str = $(this).text();
	if (str == "Remover segmento") {
		handleRemoverSegmentoEvent();
	} else {
		handleRemoverLinhaColunaEvent();
	}
	$("#remover-menu").hide();
    });

    var task_shortname = "#task_shortname#";
    var endpoint = "/pybossa";
    var img_url;

    function loadData( data ) {


        if ( !$.isEmptyObject(data.task) ) {
                 loadUserProgress();
		 $("#question").text(data.question);
		 $("#task-id").text(data.task.id);
		 console.log("data: " + data.task);
		 var coords = data.task.info.last_answer != undefined ? data.task.info.last_answer.coords : data.task.info.coords;
		 var zoom = data.task.info.zoom;
		 var hasZoom = data.task.info.hasZoom;
		 img_url = data.task.info.img_url;
		 initGrid(coords, img_url, hasZoom, zoom);
		 $("#adicionar_linha_coluna").show();
         } else {
	        $(".skeleton").hide();
        	$("#finish").fadeIn();
	}

     }

// Function to submit and save the TaskRun in PyBossa
function submitTask() {
        // Get grid infos

        var gridCoords = salvarAlteracoes();

        var answer = {'img_url' : img_url, 'coords': gridCoords};
        console.log(answer);
	// Get the task-id
	taskid = $("#task-id").text();
		
        console.log("taskid: " + taskid);
	// Save the task
	pybossa.saveTask(taskid, answer).done(function(data) {
		//Call tt workflow api.
        //taskRunDone(taskid);
        clearCanvas();

        // $.blockUI({message: $("#success"),
        //              css: {height: $("#success").height()}
        //  });
			// Load a new task
			console.log("OKOK");
        pybossa.newTask(task_shortname).done(function(data) {
        	console.log("OKOK2");	
        	loadData(data);
			});
			
	});
}

pybossa.setEndpoint(endpoint);

$(window).load(function(){
        pybossa.newTask(task_shortname).done(
            function( data ) {
                loadData( data )
                });
        
});

</script>
