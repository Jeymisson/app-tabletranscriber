<style type="text/css">
.ttImage {
	width: 550px;
	height: 700px;
	border: 1px solid;
}

#image-container {
	width: 550px;
	height: 700px;
	margin-left: 20px;
	display: block;
}

#button_help {
	font-size: 20px;
	float: right;
}

#button_share {
	font-size: 20px;
	float: right;
	margin-right: 4px;
}

#answer {
	width: 595px;
}

#disqus_thread {
	width: 595px;
	margin-top: 20px;
}

#share-container {
	position: absolute;
}

#share-menu {
	display: none;
	position: absolute;
}

.popover-content{
	display: none;
}
</style>

<div class="row" style="margin-left: 10px;">

	<div class="span6" style="height: 50px">
		<div id="success" class="alert alert-success" style="display: none;">
			<a class="close">x</a>
			<p>
				<span><strong>#</strong></span><span>#</span>
			</p>
		</div>
		<div id="finish" class="alert alert-success" style="display: none;">
			<p>
				<span><strong>#</strong></span><span>#</span>
			</p>
		</div>
		<div id="error" class="alert alert-error" style="display: none;">
			<a class="close">x</a>
			<p>
				<span><strong>#</strong></span><span>#</span>
			</p>
		</div>
		<div id="workflowtask" class="alert alert-success"
			style="display: none; text-align: center; cursor: pointer; position: relative; margin-top: 5px;"></div>
	</div>
</div>

<div class="skeleton">
	<h1 id="question"></h1>
</div>

<div class="skeleton">
	<!-- Answer buttons -->
	<div id="answer">
		<button id="button_yes" class="btn btn-success"
			onclick="submitTask('Yes')">
			<i class="icon icon-white icon-ok"></i>
		</button>
		<button id="button_no" class="btn btn-danger"
			onclick="submitTask('No')">
			<i class="icon icon-white icon-remove"></i>
		</button>
		<button id="button_ntk" class="btn" onclick="submitTask('NotKnown')"></button>
		<button id="button_help" class="btn help" data-toggle="modal" rel="tooltip" title="Abre a tela de ajuda"
			onclick="showHelpSelect()">
			<i class="icon icon-question-sign"></i>
		</button>
		<button id="button_share" class="btn" rel="tooltip" title="Compartilhe algo interessante da página abaixo" onclick="share()">
			<img class="icon" style="width: 20px"
				src="#server/images/share_icon.png"></img>
		</button>

		<div style="margin-top:10px; margin-bottom: 10px;">
			<span id="progress-from">#</span><span id="done"
				class="label label-info" style="margin-right: 5px"></span><span
				id="progress-to">#</span>
			<!-- Progress bar for the user -->
			<span id="total" class="label label-inverse"></span>
		</div>
		<div class="progress progress-striped">
			<div id="progress" rel="tooltip" title="#" class="bar"
				style="width: 0%;"></div>
		</div>
	</div>
</div>

<div id="image-container" class="skeleton" rel="popover" title="Clique e arraste o mouse sobre uma área da tabela para compartilhar.">
	<a id="image-link" href="#" target="_blank" style="float: left;"> 
		<img id="image" class="ttImage" src="#" onload="$.unblockUI();">
	</a>
	<div id="share-container">
		<ul id="share-menu" class="dropdown-menu" role="menu">
		  <li><a style="padding: 3px 12px;" onclick="shareOnFacebook()"> 
			<img class="icon" style="width: 20px; margin-right: 3px;" src="#server/images/social_facebook.png"></img>
			Facebook
		      </a>
		  </li>
		</ul>
		<div id="share-canvas-container"></div>
	</div>
</div>

<div class="skeleton">
	<div id="disqus_thread"></div>
</div>

<div id="helpModalSelect" class="modal hide fade" tabindex="-1"
	role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"
	style="display: none">

	<div class="modal-header">
		<button class="close" data-dismiss="modal" aria-hidden="true">
			<i class="icon-white icon-remove"></i>
		</button>
		<h3 id="myModalLabel">
			<strong>Tutorial de Seleção de Tabelas</strong>
		</h3>
	</div>

	<div class="modal-body">
		<h2>O que deve ser feito?</h2>
		<p>A tarefa consiste em selecionar as páginas em que existe pelo
			menos uma tabela.</p>
		<br>
		<p>
			<strong style="color: red">Atenção</strong>
		</p>
		<p>- Caso esteja visível apenas uma parte da tabela confirme que
			existe uma tabela na página.</p>
		<p>- Caso você tenha alguma dúvida se existe ou não uma tabela na
			página, envie um feedback com sua dúvida no campo logo abaixo da
			página.</p>
		<br>
		<h2>O que devo considerar uma tabela?</h2>
		<p>Você deve considerar uma tabela qualquer estrutura que possua
			dados sobre economia, geografia, demografia ou outra matéria para
			fins estatísticos.</p>
		<p style="color:red">Índices e sumários dos livros não são considerados
			tabelas válidas para nossa aplicação.</p>
		<br>
	</div>

	<div class="modal-footer">
		<button class="btn" data-dismiss="modal" aria-hidden="true">Fechar</button>
	</div>
</div>

<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname = 'lsdpybossa'; // required: replace example with your forum shortname
	//var disqus_developer = 1;

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
		var dsq = document.createElement('script');
		dsq.type = 'text/javascript';
		dsq.async = true;
		dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document
				.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>
	Please enable JavaScript to view the <a
		href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span
	class="logo-disqus">Disqus</span></a>

<script src="#server/js/kinetic.js"></script>
<script type="text/javascript" src="#server/js/share.js"></script>
<script src="//connect.facebook.net/en_US/all.js"></script>
<script type="text/javascript" src="#server/js/jquery.i18n.min.js"></script>
<script type="text/javascript" src="#server/js/tt-select-i18n.js"></script>
<script type="text/javascript" src="#server/js/jquery.blockUI.js"></script>

<script type="text/javascript" charset="utf-8">

	var task_shortname = "#task_shortname#";
	var endpoint = "/pybossa";

	function showHelpSelect() {
		$("#helpModalSelect").modal();
	}

	$("[rel=tooltip]").tooltip();

	$(window).load(function() {
		$("#question").text($.i18n._('question'));

		$("#button_yes").text($.i18n._('button_yes'));
		$("#button_yes").button({
			icons : {
				primary : "icon icon-white icon-ok"
			}
		});

		$("#button_no").text($.i18n._('button_no'));
		$("#button_no").button({
			icons : {
				primary : "icon icon-white icon-remove"
			}
		});

		$("#button_ntk").text($.i18n._('button_ntk'));

		$('#button_help').button({
			icons : {
				primary : 'icon-white icon-question-sign'
			}
		});

		$("#success strong").text($.i18n._('well_done'));
		$("#success span:nth-child(2)").text($.i18n._('saved'));
		$("#finish strong").text($.i18n._('congratulations'));
		$("#finish span:nth-child(2)").text($.i18n._('finished'));
		$("#error strong").text($.i18n._('error'));
		$("#error span:nth-child(2)").text($.i18n._('err_msg'));
		$("#workflowtask").text($.i18n._('workflowtask'));
		$("#progress-from").text($.i18n._('progress-from'));
		$("#progress-to").text($.i18n._('progress-to'));

	}); //Internationalization using jquery.i18n

	function loadUserProgress() {
		pybossa.userProgress(task_shortname).done(function(data) {
			var pct = Math.round((data.done * 100) / data.total);
			$("#progress").css("width", pct.toString() + "%");
			$("#progress").attr("title", pct.toString() + "% completed!");
			$("#progress").tooltip({
				'placement' : 'left'
			});
			$("#total").text(data.total);
			$("#done").text(data.done);
		});
	}

	function taskRunDone(taskId) {
		$.ajax({
			url : '/mb/api/' + taskId + '/done',
			success : function(data) {
				enableNextTask(taskId);
			}
		});
	}

	function enableNextTask(taskId) {
		$.ajax({
			url : '/mb/api/' + taskId + '/available_tasks',
			success : function(data) {
				if (data == "True") {
					$("#workflowtask").fadeIn(200);
				}
			}
		});

		$("#workflowtask").click(
				function() {
					window.open(endpoint + "/app/"
							+ task_shortname.replace("_tt1", "_tt2")
							+ "/newtask", "_self");
				});
	}

	function loadData(data) {
		if (!$.isEmptyObject(data.task)) {
			loadUserProgress();
			task_id = data.task.id;
			$("#image-link").attr("href", data.task.info.url_b);
			$("#image").attr("src", data.task.info.url_m);
			initSharer(task_id, pybossa.getCurrentUserId());
		} else {
			$(".skeleton").hide();
			//$("#finish").fadeIn();
			window.open(endpoint + "/app/"
					+ task_shortname.replace("_tt1", "_tt2") + "/newtask",
					"_self");
		}
	}

	// Function to submit and save the TaskRun in PyBossa
	function submitTask(answer) {
		// Get the task-id
		taskid = task_id;

		// Save the task
		pybossa.saveTask(taskid, answer).done(function(data) {
			//Call tt workflow api.
			taskRunDone(taskid);

			$.blockUI({
				message : $("#success"),
				css : {
					height : $("#success").height()
				}
			});
			// Load a new task
			pybossa.newTask(task_shortname).done(function(data) {
				loadData(data);
			});
		});
	}

	pybossa.setEndpoint(endpoint);
	pybossa.newTask(task_shortname).done(function(data) {
		loadData(data)
	});
</script>
