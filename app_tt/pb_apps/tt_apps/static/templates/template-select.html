<div id="template-container">
<div class="row">
	<div id="alert-container" class="span7" style="height: 50px">
		<div id="success" class="alert alert-success" style="display: none;">
			<p>
				<span><strong>#</strong></span><span>#</span>
			</p>
		</div>
		<div id="finish" class="alert alert-success" style="display: none;">
			<p>
				<span><strong>#</strong></span><span>#</span>
			</p>
		</div>
		<div id="error" class="alert alert-error" style="display: none;">
			<p>
				<span><strong>#</strong></span><span>#</span>
			</p>
		</div>
		<div id="workflowtask" class="alert alert-success"
			style="display: none; text-align: center; cursor: pointer; position: relative; margin-top: 5px;"></div>
	</div>
</div>

<div class="skeleton">
	<h1 id="question"></h1>
</div>

<div class="skeleton">
	<!-- Answer buttons -->
	<div id="answer">
		<button id="button_yes" class="btn btn-success"
			onclick="submitTask('Yes')">
			<i class="icon icon-white icon-ok"></i>
		</button>
		<button id="button_no" class="btn btn-danger"
			onclick="submitTask('No')">
			<i class="icon icon-white icon-remove"></i>
		</button>
		<button id="button_ntk" class="btn" onclick="submitTask('NotKnown')"></button>
		<button id="button_bug_report" class="btn btn-warning" rel="tooltip" 
			title="Aponte um erro na tarefa" onclick="showBugReportForm()">
			<i class="icon icon-warning-sign"></i>
		</button>
		<button id="button_help" class="btn help" data-toggle="modal" rel="tooltip" title="Abre a tela de ajuda"
			onclick="showHelpSelect()">
			<i class="icon icon-question-sign"></i>
		</button>
		<button id="button_share" class="btn" rel="tooltip" title="Compartilhe algo interessante da página abaixo" onclick="share()">
			<img class="icon" src="#server/images/share_icon.png"></img>
		</button>
		<div style="margin-top:10px; margin-bottom: 10px;">
			<span id="progress-from">#</span><span id="done"
				class="label label-info" style="margin-right: 5px"></span><span
				id="progress-to">#</span>
			<!-- Progress bar for the user -->
			<span id="total" class="label label-inverse"></span>
		</div>
		<div class="progress progress-striped">
			<div id="progress" rel="tooltip" class="bar"
				style="width: 0%;"></div>
		</div>
	</div>
</div>

<div id="bug_report_div" class="skeleton">
	<div>
		<h2 id="bug_report_question">  Selecione as opções abaixo que correspondem ao problema encontrado:</h2>
		<form id="bug_report_form" style="margin: 0 auto;">
		<input id="loading" type="checkbox" value="1"> A imagem não carrega<br>
		<input id="submission" type="checkbox" value="2"> A página travou quando tentei submeter<br>
		<input id="loading_next" type="checkbox" value="3"> A próxima tarefa não carrega<br>
		<input id="other" type="checkbox" value="4"> Outro<br>
		<textarea type="textarea" id="other_description" rows="0" style="width:240px"></textarea><br>
		<a class="btn btn-default btn-sm" style="float:left;" onclick="cancelSubReport()"> Cancelar</a>
		<a class="btn btn-info btn-sm"style="float:right;" onclick="subReport()"> Submeter</a><br><br>
		</form>
	</div>
</div>

<div id="image-container" class="skeleton" rel="popover" title="Clique e arraste o mouse sobre uma área da tabela para compartilhar.">
	<a id="image-link" href="#" target="_blank" style="float: left; display: none;"> 
		<img id="image" class="ttImage" src="#" onload="unblockUI();">
	</a>
	<div id="share-container">
		<ul id="share-menu" class="dropdown-menu" role="menu">
		  <li><a style="padding: 3px 12px;" onclick="shareOnFacebook()"> 
			<img class="icon" style="width: 20px; margin-right: 3px;" src="#server/images/social_facebook.png"></img>
			Facebook
		      </a>
		  </li>
		</ul>
		<div id="share-canvas-container"></div>
	</div>
	<div id="loading-container">
		<img src="#server/images/loading.gif">
	</div>
</div>

<div id="helpModalSelect" class="modal hide fade" tabindex="-1"
	role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"
	style="display: none">

	<div class="modal-header">
		<button class="close" data-dismiss="modal" aria-hidden="true">
			<i class="icon-white icon-remove"></i>
		</button>
		<h3 id="myModalLabel">
			<strong>Tutorial de Seleção de Tabelas</strong>
		</h3>
	</div>

	<div class="modal-body">
		<h2>O que deve ser feito?</h2>
		<p>A tarefa consiste em selecionar as páginas em que existe pelo
			menos uma tabela.</p>
		<br>
		<p>
			<strong style="color: red">Atenção</strong>
		</p>
		<p>- Caso esteja visível apenas uma parte da tabela confirme que
			existe uma tabela na página.</p>
		<p>- Caso você tenha alguma dúvida se existe ou não uma tabela na
			página, envie um feedback com sua dúvida no campo logo abaixo da
			página.</p>
		<br>
		<h2>O que devo considerar uma tabela?</h2>
		<p>Você deve considerar uma tabela qualquer estrutura que possua
			dados sobre economia, geografia, demografia ou outra matéria para
			fins estatísticos.</p>
		<p style="color:red">Índices e sumários dos livros não são considerados
			tabelas válidas para nossa aplicação.</p>
		<br>
	</div>

	<div class="modal-footer">
		<button class="btn" data-dismiss="modal" aria-hidden="true">Fechar</button>
	</div>
</div>
</div>

<script src="#server/js/kinetic.js"></script>
<script type="text/javascript" src="#server/js/share.js"></script>
<script src="//connect.facebook.net/en_US/all.js"></script>
<script type="text/javascript" src="#server/js/jquery.i18n.min.js"></script>
<script type="text/javascript" src="#server/js/tt-select-i18n.js"></script>
<script type="text/javascript" src="#server/js/jquery.blockUI.js"></script>
<script type="text/javascript" src="#server/js/report.js"></script>

<link rel="stylesheet" type="text/css" href="#server/css/tt-select.css" />

<script type="text/javascript" charset="utf-8">

	var app_shortname = "#app_shortname#";
	var endpoint = "/pybossa";
	
	function unblockUI() {
		$("#loading-container").hide();
		$("#image-link").show();
		$.unblockUI();
	}
	
	function blockUI() {
		$("#image-link").hide();
		$("#loading-container").show();
		
		$.blockUI({
			message : $("#success"),
			css : {
				height : $("#success").height()
			}
		});
	}

	function showHelpSelect() {
		$("#helpModalSelect").modal();
	}
	
	function callbackGetUserId( u_ident ) {
		var submissionP = $("#submission")[0].checked;
		var loadingCurrentTaskP = $("#loading")[0].checked;
		var loadingNextTaskP = $("#loading_next")[0].checked;
		var otherP = $("#other")[0].checked;
		var otherTextDescriptionP = $("#other_description").val();
		
		var msg = {
				'1' : submissionP, 
				'2' : loadingCurrentTaskP, 
				'3' : loadingNextTaskP,
				'4' : otherP,
				'5' : otherTextDescriptionP
		};
		
		var jreport = JSON.stringify({ 'message':msg, 'u_id':u_ident });
		
		$.ajax({
			type: 'POST',
			url : '/mb/api/' + app_shortname + '/' + taskId + '/report',
			dataType: 'json',
			contentType: 'application/json; charset=utf-8',
			data : jreport
		});
		
		erase_bug_report_div();
	}
	
	function subReport() {
		pybossa.getCurrentUserId( callbackGetUserId );
	}
	
	$("[rel=tooltip]").tooltip();
	$("[rel=popover]").popover({"trigger": "manual"});

	$("#template-container").ready(function() {
		$("#question").text($.i18n._('question'));

		$("#button_yes").text($.i18n._('button_yes'));
		$("#button_yes").button({
			icons : {
				primary : "icon icon-white icon-ok"
			}
		});

		$("#button_no").text($.i18n._('button_no'));
		$("#button_no").button({
			icons : {
				primary : "icon icon-white icon-remove"
			}
		});

		$("#button_ntk").text($.i18n._('button_ntk'));

		$("#success strong").text($.i18n._('well_done'));
		$("#success span:nth-child(2)").text($.i18n._('saved'));
		$("#finish strong").text($.i18n._('congratulations'));
		$("#finish span:nth-child(2)").text($.i18n._('finished'));
		$("#error strong").text($.i18n._('error'));
		$("#error span:nth-child(2)").text($.i18n._('err_msg'));
		$("#workflowtask").text($.i18n._('workflowtask'));
		$("#progress-from").text($.i18n._('progress-from'));
		$("#progress-to").text($.i18n._('progress-to'));

	}); //Internationalization using jquery.i18n

	function loadUserProgress() {
		pybossa.userProgress(app_shortname).done(function(data) {
			var pct = Math.round((data.done * 100) / data.total);
			$("#progress").css("width", pct.toString() + "%");
			
			$("#progress").tooltip('destroy');
			$("#progress").attr("data-original-title", pct.toString() + "% " + $.i18n._('completed'));
			$("#progress").tooltip({
				'placement' : 'left'
			});
			$("#total").text(data.total);
			$("#done").text(data.done);
		});
	}

	function taskRunDone(taskId) {
		$.ajax({
			url : '/mb/api/' + taskId + '/done',
			success : function(data) {
				enableNextTask(taskId);
			}
		});
	}

	function enableNextTask(taskId) {
		$.ajax({
			url : '/mb/api/' + taskId + '/available_tasks',
			success : function(data) {
				if (data == "True") {
					$("#workflowtask").fadeIn(200);
				}
			}
		});

		$("#workflowtask").click(
				function() {
					redirectToANewTask("tt2");
				});
	}

	function loadData(data) {
		if (!$.isEmptyObject(data.task)) {
			loadUserProgress();
			task_id = data.task.id;
			$("#image-link").attr("href", data.task.info.url_b);
			$("#image").attr("src", data.task.info.url_m);
			pybossa.getCurrentUserId(function(userId) {
				initSharer(task_id, userId);	
			});
		} else {
			unblockUI();
			$(".skeleton").hide();
			$("#finish").fadeIn(
					100,
					function() {
						setTimeout(function() {
							redirectToANewTask(getARandomTask());
						}, 1500);
					});
		}
		if ($("#button_share").hasClass("active")) {
			disableShare();			
		}
	}
	
	function redirectToANewTask(taskSufix) {
		window.open(endpoint
				+ "/app/"
				+ app_shortname.replace("_tt1", "_" + taskSufix)
				+ "/newtask", "_self");
	}

	function getARandomTask() {
		var nextTaskArr = ["tt2", "tt3", "tt4"];
		//return nextTaskArr[getRandomInt(0,nextTaskArr.length-1)];
		return "tt2";
	}

	function getRandomInt(min, max) {
	    return Math.floor(Math.random() * (max - min + 1)) + min;
	}

	// Function to submit and save the TaskRun in PyBossa
	function submitTask(answer) {
		// Get the task-id
		taskid = task_id;

		// Save the task
		pybossa.saveTask(taskid, answer).done(function(data) {
			//Call tt workflow api.
			taskRunDone(taskid);

			blockUI();
			
			// Load a new task
			pybossa.newTask(app_shortname).done(function(data) {
				loadData(data);
			});
		});
	}

	pybossa.setEndpoint(endpoint);
	pybossa.newTask(app_shortname).done(function(data) {
		loadData(data);
	});
</script>